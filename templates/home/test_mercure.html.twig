{% extends 'base.html.twig' %}

{% block title %}
  Test Mercure
{% endblock %}

{% block body %}
  <style>
    .example-wrapper {
      margin: 1em auto;
      max-width: 800px;
      width: 95%;
      font: 18px/1.5 sans-serif;
    }
    .example-wrapper code {
      background: #f5f5f5;
      padding: 2px 6px;
    }
    #mercure-content {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
      min-height: 100px;
    }
  </style>

  <div class="example-wrapper">
    <h1>Test Mercure</h1>

    <p>{{ message }}</p>

    <form id="message-form">
      <input type="text" id="message-input" placeholder="Enter a message" />
      <button type="submit">Send Message</button>
    </form>

    <div id="mercure-content">
      <h3>Received Messages:</h3>
    </div>

    <script>
      const url = new URL('http://localhost:3000/.well-known/mercure')
      url.searchParams.append('topic', 'https://example.com/books/1')
      
      const eventSource = new EventSource(url)
      
      eventSource.onmessage = (event) => {
        console.log(JSON.parse(event.data))
        const message = JSON.parse(event.data).status
        const messageElement = document.createElement('p')
        messageElement.textContent = message
        document.getElementById('mercure-content').appendChild(messageElement)
      }
      
      // Form submission
      document.getElementById('message-form').addEventListener('submit', function (e) {
        e.preventDefault()
        const message = document.getElementById('message-input').value
        fetch('/test-mercure', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: message })
        })
          .then((response) => response.json())
          .then((data) => console.log(data))
          .catch((error) => console.error('Error:', error))
        document.getElementById('message-input').value = ''
      })
    </script>
  </div>
{% endblock %}
